{% extends "base.html" %}
{# available:
    head
    head_js
    documentready_js
    display_menu
    display_items
    display_controls
    body
#}

{% block head_js %}
        var gid;
        var graphdata = [
            {'key': 'success', 'values': []},
            {'key': 'ignore', 'values': []},
            {'key': 'failure', 'values': []},
            {'key': 'correctIgnore', 'values': []},
        ];

        var chart;

        function getvalue(data, di, index) {
            if (index >= data[di]['values'].length) {
                return [false, data[di]['values'][data[di]['values'].length - 1]];
            } else {
                return [true, data[di]['values'][index]];
            };
        };

        function redraw() {
            // copy data
            mi = 0;
            inds = {};
            cvs = {};
            for (i in graphdata) {
                vn = graphdata[i]['key']
                vs = [];
                v = client.varbyname(vn);
                evs = v.events();
                for (vi in evs) {
                    // TODO value checking
                    vs.push([evs[vi].time, evs[vi].value]);
                };
                vs.sort(function(a, b) { return a[0] - b[0]; });
                graphdata[i]['values'] = vs;
                mi = Math.max(mi, vs.length);
                //inds[graphdata[i]['key']] = 0;
                inds[i] = 0;
                cvs[i] = [];
            };
            // prep data
            alldone = false;
            rs = {};
            values = {};
            while (!alldone) {
                // get values for all data
                mt = Infinity;
                mdi = 0;
                for (di in inds) {
                    r = getvalue(graphdata, di, inds[di]);
                    rs[di] = r[0];
                    values[di] = r[1];
                    // find one with lowest time
                    if ((r[1][0] < mt) && (r[0])) {
                        mt = r[1][0];
                        mdi = di;
                    };
                };
                alldone = true;
                for (i in rs) {
                    alldone = alldone && (!rs[i]);
                };
                if (alldone) {
                    break;
                };
                // match all others to that
                for (di in inds) {
                    cvs[di].push([mt, values[di][1]]);
                };
                // increment that time for that one
                inds[mdi] += 1;
                alldone = true;
                for (i in rs) {
                    alldone = alldone && (!rs[i]);
                };
            };

            for (di in cvs) {
                graphdata[di]['values'] = cvs[di];
                graphdata[di]['values'].sort(function(a, b) { return a[0] - b[0] });
            };

            console.log(graphdata);
            d3.select('#chart')
                .datum(graphdata)
              .transition().duration(500)
                .call(chart);
        };

        function make_graphs() {
            chart = nv.models.stackedAreaChart()
                .x(function(d) { return d[0] })
                .y(function(d) { return d[1] });
            chart.xAxis.tickFormat(d3.format('i'));
            chart.yAxis.tickFormat(d3.format('i'));
            redraw();
            nv.utils.windowResize(chart.update);
            start_graphing();
        };

        function start_graphing() {
            gid = window.setInterval(redraw, 1000);
        };

        function stop_graphing() {
            window.clearInterval(gid);
        };

{% endblock %}

{% block documentready_js %}
            client.after_codec = function () {
                client.apply_binding('#disp_controls');
                // graph stuff
                for (i in graphdata) {
                    k = graphdata[i]['key'];
                    client.varbyname(k).n = 100;
                };
                make_graphs();
            };

{% endblock %}
{% block display_controls %}
                <!-- example button control that sends most recent value -->
                <div var-bind="button=client.varbyname('reward_duration').latest_value():LickOutput1">Give Reward</div>
                <div var-bind="button=1000:LickInput">Trigger LickInput</div>
                <h1 class="control_heading">Basics</h1>
                <div class="multicolumn_block">
                    <div class="control_column">
                        <h2 class="control_heading">Reward</h2>
                        <div var-bind="check:FlagAlwaysReward">Always Reward</div>
                        <div var-bind="reward_duration">ml</div>
                        <div var-bind="button=client.varbyname('reward_duration').latest_value():LickOutput1">Give Reward</div>
                    </div>
                    <div class="control_column">
                        <h2 class="control_heading">Punishment</h2>
                        <div var-bind="check:FlagPunishLicking">Punish Licking</div>
                        <div var-bind="check:FlagPunishMoving">Punish Moving</div>
                        <div var-bind="check:FlagLongPunishment">Long Punishment</div>
                        <div var-bind="Number_PunishmentCycles">N Cycles</div>
                        <div var-bind="timeout_time">Timeout</div>
                    </div>
                    <div class="control_column">
                        <h2 class="control_heading">Timing</h2>
                        <div var-bind="StimulusPresentation_time">Target Duration</div>
                        <div var-bind="DistractorPresentation_Time">Distractor Duration</div>
                        <div var-bind="TargetIdleTime">Target Idle Time</div>
                        <div var-bind="DistractorIdleTime">Distractor Idle Time</div>
                        <div var-bind="reward_time">Reward Time</div>
                    </div>
                </div>
                <h1 class="control_heading">Performance</h1>
                <div>
                    <div var-bind="success">Targets licked</div>
                    <div var-bind="ignore">Targets ignored</div>
                    <div var-bind="failure">Bad Licks</div>
                    <div var-bind="correctIgnore">Distractors correctly ignored</div>
                </div>
                <h1 class="control_heading">IO</h1>
                <div class="multicolumn_block">
                    <div class="control_column">
                        <h2 class="control_heading">Phidget</h2>
                        <div var-bind="LickInput">LickInput</div>
                        <div var-bind="button=1000:LickInput">Trigger Lick</div>
                        <div var-bind="MotionInput1">Motion1</div>
                        <div var-bind="MotionInput2">Motion2</div>
                        <div var-bind="RefMotionAxis1">RefMotion2</div>
                        <div var-bind="RefMotionAxis2">RefMotion2</div>
                        <div var-bind="ThMotion">Motion Threshold</div>
                        <div var-bind="ThLickingMotion">Licking Motion Threshold</div>
                    </div>
                    <div class="control_column">
                        <h2 class="control_heading">CNC</h2>
                        <div var-bind="path_origin_x">Origin X</div>
                        <div var-bind="path_origin_y">Origin Y</div>
                        <div var-bind="path_origin_z">Origin Z</div>
                        <div var-bind="path_slope_x">Slope X</div>
                        <div var-bind="path_slope_y">Slope Y</div>
                        <div var-bind="path_slope_z">Slope Z</div>
                        <div var-bind="path_depth">Path Depth</div>
                    </div>
                    <div class="control_column">
                        <h2 class="control_heading">Eye</h2>
                        <div var-bind="calibration_status">Status</div>
                        <div var-bind="pupil_radius">Radius</div>
                        <div var-bind="gaze_h">Horizontal</div>
                        <div var-bind="gaze_v">Vertical</div>
                    </div>
                </div>
{% endblock %}
